# Canonical: Structured rule blocks for Governance State Machine + Deep Mode
# This file is additive and must not conflict with ARCHITECTURE_RULES.md.

schema_version: "2.0"
domain: "sagt_canon"
module: "governance_states"
module_version: "1.0"

rules:
  - id: "A11"
    title: "Governance State Machine Is Mandatory"
    precedence: 1
    type: "invariant"
    scope: "governance"
    statement:
      must:
        - "Governance MUST operate as an explicit state machine."
        - "Mixed-state output MUST halt."
        - "Illegal transitions MUST halt."
      must_not:
        - "Infer transitions implicitly."
    enforcement:
      action: "BLOCK"
      severity: "CRITICAL"
      trigger:
        - "mixed_state_output"
        - "illegal_transition"
        - "state_ambiguity"
    references:
      canon_files:
        - "src/governance/state-machine.md"
        - "src/canon/ENFORCEMENT_MATRIX.md"
        - "src/canon/TERMINOLOGY.md"

  - id: "A12"
    title: "Deep Governance Mode"
    precedence: 1
    type: "mode_definition"
    scope: "governance"
    mode:
      name: "Deep Governance Mode"
      state_id: "deep"
      algorithm:
        max_passes: 3
        convergence_rule: "two_consecutive_passes_no_new_risks"
        pass_requirements:
          - "re_evaluate_canonical_precedence"
          - "check_protected_zones"
          - "check_security_implications_no_invention"
          - "revalidate_task_group"
          - "evaluate_determinism_stability"
          - "detect_shadow_architecture_risk"
          - "detect_mutation_necessity"
      output_contract:
        allowed:
          - "risk_list"
          - "canon_citations"
          - "determinism_impact"
          - "mutation_required_flag"
          - "execution_safe_flag"
        forbidden:
          - "implementation_steps"
          - "file_edits"
          - "invented_security_boundaries"
      failure_behavior:
        on_pass_3_new_risks: "HITL"
        hitl_marker: "[AWAIT_HUMAN_VALIDATION]"
    enforcement:
      action: "HITL"
      severity: "HIGH"
      trigger:
        - "pass_3_new_risks"
        - "security_boundary_ambiguity"
        - "protected_zone_uncertainty"
        - "precedence_ambiguity"
    references:
      canon_files:
        - "src/governance/deep-governance-mode.md"
        - "src/canon/ARCHITECTURE_RULES.md"
        - "src/canon/ENFORCEMENT_MATRIX.md"

  - id: "A13"
    title: "Mode Transition Invariants"
    precedence: 1
    type: "transition_constraints"
    scope: "governance"
    transitions:
      allowed:
        - from: "normal"
          to: "deep"
          trigger: "ENTER_DEEP_GOVERNANCE_MODE"
        - from: "normal"
          to: "spec"
          trigger: "ENTER_SPEC_MODE"
        - from: "normal"
          to: "exec"
          trigger: "ENTER_EXEC_MODE"
          requires:
            - "approved_tasks_md"
        - from: "deep"
          to: "spec"
          condition: "execution_safe_true"
        - from: "deep"
          to: "hitl"
          condition: "ambiguity_or_instability"
        - from: "spec"
          to: "hitl"
          condition: "approval_required"
        - from: "spec"
          to: "normal"
          condition: "spec_delivered"
        - from: "exec"
          to: "normal"
          condition: "tasks_complete"
        - from: "exec"
          to: "hitl"
          condition: "blocked_or_conflict"
      forbidden:
        - from: "deep"
          to: "exec"
        - from: "spec"
          to: "exec"
          unless: "explicit_user_reentry"
    enforcement:
      action: "BLOCK"
      severity: "CRITICAL"
      trigger:
        - "forbidden_transition_attempted"
        - "exec_without_approved_tasks"
        - "spec_attempts_execution"
        - "deep_attempts_exec"
    references:
      canon_files:
        - "src/canon/state-schema-v2.yaml"
        - "src/governance/state-machine.md"
