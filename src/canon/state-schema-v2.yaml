# Governance State Machine Schema v2
# Machine-readable representation of governance states and transitions.
# Canonical. Must not conflict with ARCHITECTURE_RULES.md.

version: "1.0"
type: "governance_state_machine"

states:
  - id: normal
    description: "Default governed state."

  - id: deep
    description: "Deep Governance Mode. Validation-only."
    constraints:
      max_passes: 3
      convergence_rule: "two_consecutive_passes_no_new_risks"
      forbidden_outputs:
        - implementation_steps
        - file_edits

  - id: spec
    description: "Planning-only state."
    allowed_outputs:
      - requirements.md
      - design.md
      - tasks.md
      - HANDOVER.md
    forbidden_outputs:
      - implementation_steps

  - id: exec
    description: "Execution-only state."
    requires:
      - approved_tasks_md

  - id: hitl
    description: "Human-in-the-loop pause."
    terminal: true

transitions:
  - from: normal
    to: deep
    trigger: ENTER_DEEP_GOVERNANCE_MODE

  - from: normal
    to: spec
    trigger: ENTER_SPEC_MODE

  - from: normal
    to: exec
    trigger: ENTER_EXEC_MODE
    requires:
      - approved_tasks_md

  - from: deep
    to: spec
    condition: execution_safe_true

  - from: deep
    to: hitl
    condition: ambiguity_or_instability

  - from: spec
    to: hitl
    condition: approval_required

  - from: spec
    to: normal
    condition: spec_delivered

  - from: exec
    to: normal
    condition: tasks_complete

  - from: exec
    to: hitl
    condition: blocked_or_conflict

forbidden_transitions:
  - from: deep
    to: exec
  - from: spec
    to: exec
    unless: explicit_user_reentry
